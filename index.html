<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ECR亲密关系经历量表测试</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Chart.js for radar chart -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
            min-height: 100vh;
        }
        
        .page {
            display: none;
            animation: fadeIn 0.5s ease;
        }
        
        .page.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .container {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }
        
        header {
            text-align: center;
            padding: 30px 20px;
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(106, 17, 203, 0.2);
        }
        
        h1 {
            font-size: 2.2rem;
            margin-bottom: 10px;
        }
        
        h2 {
            color: #2575fc;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
            max-width: 800px;
            margin: 0 auto 20px;
        }
        
        .intro-content {
            background-color: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
        }
        
        .intro-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 25px 0;
        }
        
        .intro-card {
            background: #f9f9f9;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border-left: 4px solid #2575fc;
        }
        
        .intro-card i {
            font-size: 2rem;
            color: #2575fc;
            margin-bottom: 10px;
        }
        
        .start-btn {
            display: block;
            width: 100%;
            max-width: 300px;
            margin: 30px auto;
            padding: 18px 30px;
            background: linear-gradient(to right, #6a11cb, #2575fc);
            color: white;
            border: none;
            border-radius: 50px;
            font-size: 1.2rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            text-decoration: none;
        }
        
        .start-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(106, 17, 203, 0.3);
        }
        
        /* 知情同意书页面样式 */
        .consent-container {
            background-color: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            max-width: 800px;
            margin: 0 auto;
        }
        
        .consent-section {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }
        
        .consent-checkbox {
            display: flex;
            align-items: flex-start;
            margin-bottom: 15px;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 10px;
            border: 2px solid #eee;
            transition: all 0.3s ease;
        }
        
        .consent-checkbox.checked {
            border-color: #6a11cb;
            background-color: #f0f0ff;
        }
        
        .consent-checkbox input {
            margin-right: 15px;
            margin-top: 3px;
            width: 20px;
            height: 20px;
        }
        
        .consent-text {
            flex: 1;
        }
        
        .consent-btn {
            display: block;
            width: 100%;
            max-width: 300px;
            margin: 30px auto;
            padding: 18px 30px;
            background: linear-gradient(to right, #6a11cb, #2575fc);
            color: white;
            border: none;
            border-radius: 50px;
            font-size: 1.2rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            opacity: 0.5;
            pointer-events: none;
        }
        
        .consent-btn.active {
            opacity: 1;
            pointer-events: all;
        }
        
        .consent-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(106, 17, 203, 0.3);
        }
        
        /* 测试页面样式 */
        .test-container {
            background-color: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }
        
        .progress-container {
            margin-bottom: 25px;
        }
        
        .progress-bar {
            height: 8px;
            background-color: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(to right, #6a11cb, #2575fc);
            width: 0%;
            transition: width 0.5s ease;
        }
        
        .progress-text {
            text-align: right;
            font-size: 0.9rem;
            color: #666;
            margin-top: 5px;
        }
        
        .question-item {
            margin-bottom: 20px;
            padding: 20px;
            border-radius: 10px;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        
        .question-item.unanswered {
            background-color: #ffeaea;
            border-color: #ffcccc;
        }
        
        .question-item.answered {
            background-color: #eaffea;
            border-color: #ccffcc;
        }
        
        .question-text {
            font-weight: 500;
            margin-bottom: 15px;
            color: #333;
        }
        
        .scale-labels {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 0.85rem;
            color: #666;
        }
        
        .scale-options {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .scale-option {
            flex: 1;
            min-width: 80px;
            text-align: center;
        }
        
        .scale-option input[type="radio"] {
            display: none;
        }
        
        .scale-option label {
            display: block;
            padding: 12px 5px;
            background-color: #f0f0f0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        
        .scale-option input[type="radio"]:checked + label {
            background: linear-gradient(to right, #6a11cb, #2575fc);
            color: white;
        }
        
        .scale-option label:hover {
            background-color: #e0e0e0;
        }
        
        .buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 30px;
            flex-wrap: wrap;
        }
        
        button {
            padding: 14px 28px;
            border: none;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            min-width: 150px;
        }
        
        #submitBtn {
            background: linear-gradient(to right, #6a11cb, #2575fc);
            color: white;
        }
        
        #prevBtn {
            background-color: #f0f0f0;
            color: #666;
        }
        
        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        #submitBtn:hover {
            box-shadow: 0 5px 15px rgba(106, 17, 203, 0.3);
        }
        
        .error-message {
            color: #ff4757;
            text-align: center;
            margin-top: 15px;
            font-weight: 500;
            display: none;
        }
        
        /* 结果页面样式 */
        .results-container {
            background-color: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }
        
        .score-display {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin: 25px 0;
        }
        
        .score-box {
            flex: 1;
            min-width: 200px;
            text-align: center;
            padding: 20px;
            border-radius: 10px;
            background-color: #f9f9f9;
            border-left: 5px solid #2575fc;
        }
        
        .score-value {
            font-size: 2.2rem;
            font-weight: bold;
            color: #2575fc;
            margin: 10px 0;
        }
        
        .attachment-type {
            text-align: center;
            padding: 25px;
            margin: 25px 0;
            border-radius: 15px;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        }
        
        .type-title {
            font-size: 1.8rem;
            color: #2575fc;
            margin-bottom: 15px;
        }
        
        .type-description {
            max-width: 800px;
            margin: 0 auto;
            font-size: 1.1rem;
            line-height: 1.8;
        }
        
        .radar-container {
            margin: 30px auto;
            max-width: 500px;
            height: 400px;
        }
        
        .recommendations {
            margin: 30px 0;
            padding: 25px;
            background-color: #f9f9f9;
            border-radius: 15px;
        }
        
        .recommendation-item {
            margin-bottom: 20px;
            padding: 15px;
            background-color: white;
            border-radius: 10px;
            border-left: 4px solid #2575fc;
        }
        
        .recommendation-item h4 {
            color: #2575fc;
            margin-bottom: 10px;
        }
        
        .navigation-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 30px;
            flex-wrap: wrap;
        }
        
        footer {
            text-align: center;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #eee;
            color: #777;
            font-size: 0.9rem;
        }
        
        /* 移动端优化 */
        @media (max-width: 768px) {
            body {
                padding: 15px;
            }
            
            h1 {
                font-size: 1.8rem;
            }
            
            h2 {
                font-size: 1.4rem;
            }
            
            .intro-grid {
                grid-template-columns: 1fr;
            }
            
            .scale-options {
                flex-direction: column;
            }
            
            .scale-option {
                min-width: 100%;
            }
            
            .score-box {
                min-width: 100%;
            }
            
            .radar-container {
                height: 300px;
            }
            
            button {
                width: 100%;
                max-width: 300px;
            }
            
            .buttons, .navigation-buttons {
                flex-direction: column;
                align-items: center;
            }
        }
        
        @media (max-width: 480px) {
            .question-item {
                padding: 15px;
            }
            
            .scale-option label {
                padding: 10px 5px;
                font-size: 0.9rem;
            }
            
            .type-title {
                font-size: 1.5rem;
            }
            
            .score-value {
                font-size: 1.8rem;
            }
            
            .radar-container {
                height: 250px;
            }
        }
    </style>
</head>
<body>
    <!-- 页面1: 介绍页面 -->
    <div id="page-intro" class="page active">
        <div class="container">
            <header>
                <h1>ECR亲密关系经历量表测试</h1>
                <p class="subtitle">成人依恋量表-亲密关系经历量表(Experiences in Close Relationships Inventory)</p>
            </header>
            
            <div class="intro-content">
                <h2><i class="fas fa-info-circle"></i> 关于ECR测试</h2>
                <p>ECR（亲密关系经历量表）是评估成人依恋风格的专业心理测评工具，由Brennan、Clark和Shaver于1998年编制。该量表通过测量亲密关系中的回避和焦虑两个核心维度，帮助您了解自己的依恋模式。</p>
                
                <div class="intro-grid">
                    <div class="intro-card">
                        <i class="fas fa-heart"></i>
                        <h3>评估维度</h3>
                        <p>测量回避和焦虑两个核心维度</p>
                    </div>
                    <div class="intro-card">
                        <i class="fas fa-chart-line"></i>
                        <h3>专业可靠</h3>
                        <p>基于心理学研究的专业评估工具</p>
                    </div>
                    <div class="intro-card">
                        <i class="fas fa-user-shield"></i>
                        <h3>隐私保护</h3>
                        <p>所有数据仅保存在您的设备中</p>
                    </div>
                </div>
                
                <h3><i class="fas fa-bullseye"></i> 评估目标</h3>
                <ul>
                    <li>了解自己在亲密关系中的依恋模式</li>
                    <li>识别关系中的回避和焦虑倾向</li>
                    <li>获得个性化的关系建议</li>
                    <li>促进更健康和谐的亲密关系</li>
                </ul>
                
                <a href="#" class="start-btn" id="startTestBtn">
                    <i class="fas fa-play-circle"></i> 开始测试
                </a>
            </div>
            
            <footer>
                <p>ECR量表(Experiences in Close Relationships Inventory)由Brennan, Clark和Shaver于1998年编制</p>
                <p>本测试结果仅供参考，不能替代专业心理评估</p>
            </footer>
        </div>
    </div>
    
    <!-- 页面2: 知情同意页面 -->
    <div id="page-consent" class="page">
        <div class="container">
            <header>
                <h1>知情同意书</h1>
                <p class="subtitle">在开始测试前，请阅读并同意以下内容</p>
            </header>
            
            <div class="consent-container">
                <div class="consent-section">
                    <h2><i class="fas fa-bullseye"></i> 评估目的</h2>
                    <p>本评估旨在帮助您了解自己在亲密关系中的依恋模式，包括回避和焦虑两个维度。这是一个基于心理学研究的自我探索工具，可以促进您对亲密关系动态的认知和理解，帮助建立更健康和谐的恋爱关系。</p>
                    
                    <div class="consent-checkbox" id="consent1">
                        <input type="checkbox" id="consentPurpose">
                        <div class="consent-text">
                            <label for="consentPurpose">我理解本评估的目的是帮助我了解亲密关系中的依恋模式</label>
                        </div>
                    </div>
                </div>
                
                <div class="consent-section">
                    <h2><i class="fas fa-user-shield"></i> 隐私保护</h2>
                    <p>您的所有回答将完全匿名化处理，仅保存在您的设备本地，不会上传到任何服务器。我们不收集任何可识别个人身份的信息，您可以随时删除本地保存的数据。您的隐私和数据安全是我们的首要关注。</p>
                    
                    <div class="consent-checkbox" id="consent2">
                        <input type="checkbox" id="consentPrivacy">
                        <div class="consent-text">
                            <label for="consentPrivacy">我理解我的数据将被匿名化处理并仅保存在本地设备上</label>
                        </div>
                    </div>
                </div>
                
                <div class="consent-section">
                    <h2><i class="fas fa-hand-paper"></i> 自愿参与</h2>
                    <p>参与本评估完全基于自愿原则，您可以在任何时候退出评估，无需说明理由。对于任何让您感到不适的问题，您都可以选择跳过。评估过程中如果您感到不适，请立即停止并寻求专业心理健康服务帮助。</p>
                    
                    <div class="consent-checkbox" id="consent3">
                        <input type="checkbox" id="consentVoluntary">
                        <div class="consent-text">
                            <label for="consentVoluntary">我理解参与是自愿的，可以随时退出评估</label>
                        </div>
                    </div>
                </div>
                
                <div class="consent-section">
                    <h2><i class="fas fa-stethoscope"></i> 非诊断性质</h2>
                    <p>本评估结果仅供自我了解和关系反思使用，不能替代专业的心理咨询或情感咨询。如果您在亲密关系中遇到严重问题，建议立即寻求专业帮助。评估结果不应被用于指责伴侣或做出重大关系决策。</p>
                    
                    <div class="consent-checkbox" id="consent4">
                        <input type="checkbox" id="consentNonDiagnostic">
                        <div class="consent-text">
                            <label for="consentNonDiagnostic">我理解这不是诊断工具，如有严重关系问题会寻求专业帮助</label>
                        </div>
                    </div>
                </div>
                
                <button class="consent-btn" id="agreeBtn" disabled>
                    <i class="fas fa-check-circle"></i> 我理解并同意开始测试
                </button>
                
                <button id="backToIntroBtn" style="background-color: #f0f0f0; color: #666; margin-top: 10px;">
                    <i class="fas fa-arrow-left"></i> 返回介绍
                </button>
            </div>
        </div>
    </div>
    
    <!-- 页面3: 测试页面 -->
    <div id="page-test" class="page">
        <div class="container">
            <header>
                <h1>ECR测试问卷</h1>
                <p class="subtitle">请根据您的真实感受选择最符合的选项</p>
            </header>
            
            <div class="test-container">
                <div class="progress-container">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <div class="progress-text">已完成 <span id="answeredCount">0</span>/36 题</div>
                </div>
                
                <div id="questionsContainer">
                    <!-- 问题将通过JavaScript动态生成 -->
                </div>
                
                <div class="error-message" id="errorMessage">
                    请回答所有问题后再提交
                </div>
                
                <div class="buttons">
                    <button id="prevBtn">
                        <i class="fas fa-arrow-left"></i> 返回
                    </button>
                    <button id="submitBtn">
                        <i class="fas fa-chart-bar"></i> 查看结果
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 页面4: 结果页面 -->
    <div id="page-results" class="page">
        <div class="container">
            <header>
                <h1>测试结果分析</h1>
                <p class="subtitle">您的ECR测试结果与个性化建议</p>
            </header>
            
            <div class="results-container">
                <h2><i class="fas fa-poll"></i> 测试结果</h2>
                
                <div class="score-display">
                    <div class="score-box">
                        <h3>回避维度得分</h3>
                        <div class="score-value" id="avoidanceScore">0.0</div>
                        <p>平均分：<span id="avoidanceMean">0.0</span></p>
                        <p>分数越高表示您在亲密关系中越倾向于回避亲密</p>
                    </div>
                    
                    <div class="score-box">
                        <h3>焦虑维度得分</h3>
                        <div class="score-value" id="anxietyScore">0.0</div>
                        <p>平均分：<span id="anxietyMean">0.0</span></p>
                        <p>分数越高表示您在亲密关系中越容易感到焦虑</p>
                    </div>
                </div>
                
                <div class="attachment-type" id="attachmentTypeResult">
                    <div class="type-title" id="typeTitle">安全型依恋</div>
                    <div class="type-description" id="typeDescription">
                        安全型依恋的个体在亲密关系中感到舒适，既能与他人建立亲密关系，也能保持独立。他们通常对关系有积极的看法，信任伴侣，并能有效处理关系中的冲突。
                    </div>
                </div>
                
                <h3><i class="fas fa-chart-radar"></i> 依恋类型得分雷达图</h3>
                <div class="radar-container">
                    <canvas id="radarChart"></canvas>
                </div>
                
                <h3><i class="fas fa-lightbulb"></i> 个性化建议</h3>
                <div class="recommendations" id="recommendations">
                    <!-- 建议将通过JavaScript动态生成 -->
                </div>
                
                <div class="navigation-buttons">
                    <button id="retakeTestBtn">
                        <i class="fas fa-redo"></i> 重新测试
                    </button>
                    <button id="backToTestBtn">
                        <i class="fas fa-arrow-left"></i> 返回测试
                    </button>
                </div>
            </div>
            
            <footer>
                <p>ECR量表(Experiences in Close Relationships Inventory)由Brennan, Clark和Shaver于1998年编制</p>
                <p>本测试结果仅供参考，不能替代专业心理评估</p>
            </footer>
        </div>
    </div>

    <script>
        // ECR量表问题数据
        const ecrQuestions = [
            { text: "总的来说,我不喜欢让恋人知道自己内心深处的感觉；", dimension: "avoidance", reverse: false },
            { text: "我担心我会被抛弃；", dimension: "anxiety", reverse: false },
            { text: "我觉得跟恋人亲近是一件惬意的事情；", dimension: "avoidance", reverse: true },
            { text: "我很担心我的恋爱关系；", dimension: "anxiety", reverse: false },
            { text: "当恋人开始要跟我亲近时,我发现我自己在退缩；", dimension: "avoidance", reverse: false },
            { text: "我担心恋人不会象我关心他(/她)那样地关心我；", dimension: "anxiety", reverse: false },
            { text: "当恋人希望跟我非常亲近时,我会觉得不自在；", dimension: "avoidance", reverse: false },
            { text: "我有点担心会失去恋人；", dimension: "anxiety", reverse: false },
            { text: "我觉得对恋人开诚布公,不是一件很舒服的事情；", dimension: "avoidance", reverse: false },
            { text: "我常常希望恋人对我的感情和我对恋人的感情一样强烈；", dimension: "anxiety", reverse: false },
            { text: "我想与恋人亲近,但我又总是会退缩不前；", dimension: "avoidance", reverse: false },
            { text: "我常常想与恋人形影不离,但有时这样会把恋人吓跑；", dimension: "anxiety", reverse: false },
            { text: "当恋人跟我过分亲密的时候,我会感到内心紧张；", dimension: "avoidance", reverse: false },
            { text: "我担心一个人独处；", dimension: "anxiety", reverse: false },
            { text: "我愿意把我内心的想法和感觉告诉恋人,我觉得这是一件自在的事情；", dimension: "avoidance", reverse: true },
            { text: "我想跟恋人非常亲密的愿望,有时会把恋人吓跑；", dimension: "anxiety", reverse: false },
            { text: "我试图避免与恋人变得太亲近；", dimension: "avoidance", reverse: false },
            { text: "我需要我的恋人一再地保证他/她是爱我的；", dimension: "anxiety", reverse: false },
            { text: "我觉得我比较容易与恋人亲近；", dimension: "avoidance", reverse: true },
            { text: "我觉得自己在要求恋人把更多的感觉,以及对恋爱关系的投入程度表现出来；", dimension: "anxiety", reverse: false },
            { text: "我发现让我依赖恋人,是一件困难的事情；", dimension: "avoidance", reverse: false },
            { text: "我并不是常常担心被恋人抛弃；", dimension: "anxiety", reverse: true },
            { text: "我倾向于不跟恋人过分亲密；", dimension: "avoidance", reverse: false },
            { text: "如果我无法得到恋人的注意和关心,我会心烦意乱或者生气；", dimension: "anxiety", reverse: false },
            { text: "我跟恋人什么事情都讲；", dimension: "avoidance", reverse: true },
            { text: "我发现恋人并不愿意象我所想的那样跟我亲近；", dimension: "anxiety", reverse: false },
            { text: "我经常与恋人讨论我所遇到的问题以及我关心的事情；", dimension: "avoidance", reverse: true },
            { text: "如果我还没有恋人的话,我会感到有点焦虑和不安；", dimension: "anxiety", reverse: false },
            { text: "我觉得依赖恋人是很自在的事情；", dimension: "avoidance", reverse: true },
            { text: "如果恋人不能象我所希望的那样在我身边时,我会感到灰心丧气；", dimension: "anxiety", reverse: false },
            { text: "我并不在意从恋人那里寻找安慰,听取劝告,得到帮助；", dimension: "avoidance", reverse: true },
            { text: "如果在我需要的时候,恋人却不在我身边,我会感到沮丧；", dimension: "anxiety", reverse: false },
            { text: "在需要的时候,我向恋人求助,是很有用的；", dimension: "avoidance", reverse: true },
            { text: "当恋人不赞同我时,我觉得确实是我不好；", dimension: "anxiety", reverse: false },
            { text: "我会在很多事情上向恋人求助,包括寻求安慰和得到承诺；", dimension: "avoidance", reverse: true },
            { text: "当恋人不花时间和我在一起时,我会感到怨恨；", dimension: "anxiety", reverse: false }
        ];
        
        // 初始化用户答案数组
        let userAnswers = new Array(ecrQuestions.length).fill(0);
        
        // 页面管理
        const pages = {
            intro: document.getElementById('page-intro'),
            consent: document.getElementById('page-consent'),
            test: document.getElementById('page-test'),
            results: document.getElementById('page-results')
        };
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            initQuestionnaire();
            updateProgress();
            setupEventListeners();
            setupConsentCheckboxes();
        });
        
        // 设置事件监听器
        function setupEventListeners() {
            // 开始测试按钮
            document.getElementById('startTestBtn').addEventListener('click', function(e) {
                e.preventDefault();
                switchPage('consent');
            });
            
            // 返回介绍按钮
            document.getElementById('backToIntroBtn').addEventListener('click', function() {
                switchPage('intro');
            });
            
            // 同意并开始测试按钮
            document.getElementById('agreeBtn').addEventListener('click', function() {
                switchPage('test');
            });
            
            // 返回按钮（从测试页）
            document.getElementById('prevBtn').addEventListener('click', function() {
                switchPage('consent');
            });
            
            // 提交按钮
            document.getElementById('submitBtn').addEventListener('click', calculateResults);
            
            // 重新测试按钮
            document.getElementById('retakeTestBtn').addEventListener('click', function() {
                resetTest();
                switchPage('test');
            });
            
            // 返回测试按钮
            document.getElementById('backToTestBtn').addEventListener('click', function() {
                switchPage('test');
            });
        }
        
        // 设置知情同意复选框
        function setupConsentCheckboxes() {
            const checkboxes = document.querySelectorAll('.consent-checkbox input[type="checkbox"]');
            const agreeBtn = document.getElementById('agreeBtn');
            
            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const parent = this.closest('.consent-checkbox');
                    if (this.checked) {
                        parent.classList.add('checked');
                    } else {
                        parent.classList.remove('checked');
                    }
                    
                    // 检查是否所有复选框都被选中
                    const allChecked = Array.from(checkboxes).every(cb => cb.checked);
                    if (allChecked) {
                        agreeBtn.classList.add('active');
                        agreeBtn.disabled = false;
                    } else {
                        agreeBtn.classList.remove('active');
                        agreeBtn.disabled = true;
                    }
                });
            });
        }
        
        // 切换页面
        function switchPage(pageName) {
            // 隐藏所有页面
            Object.values(pages).forEach(page => {
                page.classList.remove('active');
            });
            
            // 显示目标页面
            pages[pageName].classList.add('active');
            
            // 滚动到顶部
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        // 初始化问卷
        function initQuestionnaire() {
            const container = document.getElementById('questionsContainer');
            container.innerHTML = '';
            
            ecrQuestions.forEach((question, index) => {
                const questionItem = document.createElement('div');
                questionItem.className = 'question-item unanswered';
                questionItem.id = `question-${index}`;
                
                questionItem.innerHTML = `
                    <div class="question-text">${index + 1}. ${question.text}</div>
                    <div class="scale-labels">
                        <span>非常不同意</span>
                        <span>中立</span>
                        <span>非常同意</span>
                    </div>
                    <div class="scale-options">
                        ${[1, 2, 3, 4, 5, 6, 7].map(num => `
                            <div class="scale-option">
                                <input type="radio" 
                                       id="q${index}_${num}" 
                                       name="q${index}" 
                                       value="${num}"
                                       data-index="${index}"
                                       data-value="${num}">
                                <label for="q${index}_${num}">${num}</label>
                            </div>
                        `).join('')}
                    </div>
                `;
                
                container.appendChild(questionItem);
                
                // 为每个单选按钮添加事件监听器
                const radioButtons = questionItem.querySelectorAll('input[type="radio"]');
                radioButtons.forEach(radio => {
                    radio.addEventListener('change', function() {
                        const questionIndex = parseInt(this.getAttribute('data-index'));
                        const value = parseInt(this.value);
                        userAnswers[questionIndex] = value;
                        
                        // 更新问题样式
                        const questionElement = document.getElementById(`question-${questionIndex}`);
                        questionElement.classList.remove('unanswered');
                        questionElement.classList.add('answered');
                        
                        updateProgress();
                        
                        // 隐藏错误消息
                        document.getElementById('errorMessage').style.display = 'none';
                    });
                });
            });
        }
        
        // 更新进度条
        function updateProgress() {
            const answeredCount = userAnswers.filter(answer => answer !== 0).length;
            const progressPercentage = (answeredCount / ecrQuestions.length) * 100;
            
            document.getElementById('answeredCount').textContent = answeredCount;
            document.getElementById('progressFill').style.width = `${progressPercentage}%`;
        }
        
        // 计算测试结果
        function calculateResults() {
            // 检查是否所有问题都已回答
            if (userAnswers.includes(0)) {
                document.getElementById('errorMessage').style.display = 'block';
                
                // 滚动到第一个未回答的问题
                const firstUnansweredIndex = userAnswers.findIndex(answer => answer === 0);
                const unansweredElement = document.getElementById(`question-${firstUnansweredIndex}`);
                unansweredElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                
                // 添加闪烁效果
                unansweredElement.style.animation = 'none';
                setTimeout(() => {
                    unansweredElement.style.animation = 'fadeIn 0.5s ease';
                }, 10);
                
                return;
            }
            
            // 计算回避和焦虑维度得分
            let avoidanceSum = 0;
            let anxietySum = 0;
            
            for (let i = 0; i < ecrQuestions.length; i++) {
                const question = ecrQuestions[i];
                let answer = userAnswers[i];
                
                // 反向计分处理
                if (question.reverse) {
                    answer = 8 - answer;
                }
                
                if (question.dimension === "avoidance") {
                    avoidanceSum += answer;
                } else {
                    anxietySum += answer;
                }
            }
            
            // 计算平均分
            const avoidanceMean = (avoidanceSum / 18).toFixed(2);
            const anxietyMean = (anxietySum / 18).toFixed(2);
            
            // 显示结果
            document.getElementById('avoidanceScore').textContent = avoidanceSum;
            document.getElementById('avoidanceMean').textContent = avoidanceMean;
            document.getElementById('anxietyScore').textContent = anxietySum;
            document.getElementById('anxietyMean').textContent = anxietyMean;
            
            // 使用费舍尔线性判别公式计算四种类型得分
            const A = parseFloat(avoidanceMean);
            const B = parseFloat(anxietyMean);
            
            const M1 = A * 3.2893296 + B * 5.4725318 - 11.5307833; // 安全性
            const M2 = A * 7.2371075 + B * 8.1776448 - 32.3553266; // 恐惧性
            const M3 = A * 3.9246754 + B * 9.7102446 - 28.4573220; // 专注性
            const M4 = A * 7.3654621 + B * 4.9392039 - 22.2281088; // 冷漠性
            
            // 找出最高分
            const scores = [
                { name: "安全型", value: M1, type: "secure" },
                { name: "恐惧型", value: M2, type: "fearful" },
                { name: "专注型", value: M3, type: "preoccupied" },
                { name: "冷漠型", value: M4, type: "dismissing" }
            ];
            
            const highestScore = scores.reduce((max, score) => score.value > max.value ? score : max);
            
            // 更新类型描述
            updateTypeDescription(highestScore.type);
            
            // 生成雷达图
            createRadarChart(scores);
            
            // 生成个性化建议
            generateRecommendations(highestScore.type, parseFloat(avoidanceMean), parseFloat(anxietyMean));
            
            // 切换到结果页面
            switchPage('results');
        }
        
        // 更新类型描述
        function updateTypeDescription(type) {
            const typeTitles = {
                secure: "安全型依恋",
                preoccupied: "专注型(痴迷型)依恋",
                dismissing: "冷漠型(疏离型)依恋",
                fearful: "恐惧型依恋"
            };
            
            const typeDescriptions = {
                secure: "安全型依恋的个体在亲密关系中感到舒适，既能与他人建立亲密关系，也能保持独立。他们通常对关系有积极的看法，信任伴侣，并能有效处理关系中的冲突。安全型依恋的个体通常拥有更稳定、满意的亲密关系。",
                preoccupied: "专注型(痴迷型)依恋的个体渴望亲密关系，但常常担心伴侣是否同样爱自己。他们可能会过度寻求认可和安慰，对关系中的小变化非常敏感。这类个体可能表现出较强的占有欲，并倾向于过度分析关系中的互动。",
                dismissing: "冷漠型(疏离型)依恋的个体重视独立和自给自足，可能避免过于亲密的关系。他们倾向于压抑情感需求，可能认为依赖他人是软弱的表现。这类个体通常在关系中有较强的界限，并可能回避深层次的情感交流。",
                fearful: "恐惧型依恋的个体既渴望亲密关系，又害怕受到伤害。他们可能在亲近和疏远之间摇摆不定，对亲密关系持有矛盾的态度。这类个体常常担心被拒绝或抛弃，但又不愿意完全依赖他人。"
            };
            
            document.getElementById('typeTitle').textContent = typeTitles[type];
            document.getElementById('typeDescription').textContent = typeDescriptions[type];
        }
        
        // 创建雷达图
        function createRadarChart(scores) {
            const ctx = document.getElementById('radarChart').getContext('2d');
            
            // 如果已有图表实例，先销毁
            if (window.radarChartInstance) {
                window.radarChartInstance.destroy();
            }
            
            const labels = scores.map(score => score.name);
            const dataValues = scores.map(score => score.value);
            
            // 归一化数据到0-100范围
            const maxValue = Math.max(...dataValues);
            const minValue = Math.min(...dataValues);
            const normalizedData = dataValues.map(value => {
                return ((value - minValue) / (maxValue - minValue)) * 80 + 20;
            });
            
            window.radarChartInstance = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '依恋类型得分',
                        data: normalizedData,
                        backgroundColor: 'rgba(106, 17, 203, 0.2)',
                        borderColor: 'rgba(106, 17, 203, 0.8)',
                        pointBackgroundColor: 'rgba(106, 17, 203, 1)',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: 'rgba(106, 17, 203, 1)',
                        borderWidth: 2,
                        pointRadius: 4
                    }]
                },
                options: {
                    scales: {
                        r: {
                            angleLines: {
                                display: true,
                                color: 'rgba(0, 0, 0, 0.1)'
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            },
                            pointLabels: {
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                },
                                color: '#333'
                            },
                            ticks: {
                                display: false,
                                maxTicksLimit: 5
                            },
                            min: 0,
                            max: 100
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const index = context.dataIndex;
                                    return `${labels[index]}: ${dataValues[index].toFixed(2)}`;
                                }
                            }
                        }
                    },
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }
        
        // 生成个性化建议
        function generateRecommendations(type, avoidanceMean, anxietyMean) {
            const recommendationsContainer = document.getElementById('recommendations');
            recommendationsContainer.innerHTML = '';
            
            let recommendations = [];
            
            // 通用建议
            const generalRecommendations = [
                {
                    title: "自我觉察练习",
                    content: "定期记录您在亲密关系中的感受和反应，识别触发焦虑或回避的具体情境。这有助于您更好地理解自己的依恋模式。"
                },
                {
                    title: "有效沟通技巧",
                    content: "练习使用'我陈述句'表达感受（如'我感到...当...'），而非指责对方。这有助于减少防御性反应，促进理解。"
                },
                {
                    title: "逐步暴露",
                    content: "如果您有回避倾向，尝试逐步增加情感亲密度，从小小的自我表露开始，逐步建立信任。"
                }
            ];
            
            // 类型特定建议
            const typeSpecificRecommendations = {
                secure: [
                    {
                        title: "保持健康模式",
                        content: "您已具备健康的依恋模式，继续保持开放沟通和相互尊重的态度。您可以成为伴侣的安全基地，支持TA的成长。"
                    },
                    {
                        title: "帮助伴侣成长",
                        content: "如果您伴侣的依恋风格与您不同，尝试理解TA的内心世界，耐心支持TA建立更安全的依恋模式。"
                    }
                ],
                preoccupied: [
                    {
                        title: "焦虑管理技巧",
                        content: "当感到焦虑时，尝试深呼吸练习或正念冥想，帮助自己回到当下，减少对关系未来的灾难化想象。"
                    },
                    {
                        title: "建立自我价值感",
                        content: "发展个人兴趣和社交圈，减少对伴侣的过度依赖。您的价值不仅体现在亲密关系中，也体现在您个人的成就和成长中。"
                    }
                ],
                dismissing: [
                    {
                        title: "情感表达练习",
                        content: "尝试定期与伴侣分享感受，即使开始时感到不自在。可以从简单的情绪词汇开始，逐步增加深度。"
                    },
                    {
                        title: "重新认识亲密",
                        content: "亲密关系中的依赖并不等同于软弱。健康的相互依赖可以增强关系的韧性和满意度。"
                    }
                ],
                fearful: [
                    {
                        title: "矛盾心理调和",
                        content: "认识到渴望亲密又害怕受伤是正常的矛盾心理。尝试小步前进，在感到安全时逐步增加亲密，在不适时适当后退。"
                    },
                    {
                        title: "建立安全信号",
                        content: "与伴侣协商建立关系中的安全信号，当您感到 overwhelmed 时可以使用的非语言提示，帮助您在不破坏关系的前提下获得空间。"
                    }
                ]
            };
            
            // 合并建议
            recommendations = [...generalRecommendations, ...typeSpecificRecommendations[type]];
            
            // 根据具体得分添加额外建议
            if (anxietyMean > 4.0) {
                recommendations.push({
                    title: "焦虑情绪调节",
                    content: "您的焦虑得分较高，建议学习情绪调节技巧，如认知重构（挑战负面想法）、身体放松练习等，帮助管理关系中的焦虑情绪。"
                });
            }
            
            if (avoidanceMean > 4.0) {
                recommendations.push({
                    title: "逐步亲密练习",
                    content: "您的回避得分较高，建议从小的亲密行为开始练习，如定期分享日常感受、主动表达欣赏等，逐步建立情感连接的舒适感。"
                });
            }
            
            // 渲染建议
            recommendations.forEach(rec => {
                const recElement = document.createElement('div');
                recElement.className = 'recommendation-item';
                recElement.innerHTML = `
                    <h4><i class="fas fa-lightbulb"></i> ${rec.title}</h4>
                    <p>${rec.content}</p>
                `;
                recommendationsContainer.appendChild(recElement);
            });
        }
        
        // 重置测试
        function resetTest() {
            // 重置答案数组
            userAnswers = new Array(ecrQuestions.length).fill(0);
            
            // 重置所有单选按钮
            document.querySelectorAll('input[type="radio"]').forEach(radio => {
                radio.checked = false;
            });
            
            // 重置问题样式
            document.querySelectorAll('.question-item').forEach(item => {
                item.classList.remove('answered');
                item.classList.add('unanswered');
            });
            
            // 隐藏错误消息
            document.getElementById('errorMessage').style.display = 'none';
            
            // 更新进度
            updateProgress();
        }
    </script>
</body>
</html>